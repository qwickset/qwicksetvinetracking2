<!DOCTYPE html>
<!--
      About.HTML
-->
<html>

<head>
    <base target="_top">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css" rel="nofollow" integrity="sha384-r4NyP46KrjDleawBgD5tp8Y7UzmLA05oM1iAEQ17CSuDqnUK2+k9luXQOfXJCJ4I" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/js/bootstrap.min.js" integrity="sha384-oesi62hOLfzrys4LxRF63OJCXdXDipiYWBnvTl9Y9/TRlw5xlKIEHpNyvvDShgf/" crossorigin="anonymous"></script>
    <script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
    <!------ Include the above in your HEAD tag ---------->
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500&amp;display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Source+Serif+Pro:400,600&amp;display=swap" rel="stylesheet">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;700;900&display=swap');

        *,
        body {
            font-family: 'Poppins', sans-serif;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }

        .container {
            padding: 10px;
        }

        textarea {
            border: 1px solid #999999;
            width: 90%;
            margin: 5px 0;
            padding: 3px;
            font-size:15px;
        }

        .parsedIDsContainer {
            display: none;
        }

        .right {
            float: right;
        }

        #newDataTable,
        #foundDataTable,
        #statusDataTable {
            overflow: auto;
            position: relative;
            margin-bottom: 5px;
            border: 1px solid gray;
        }

        #newDataTable,
        #foundDataTable {
            height: 250px;
        }

        #statusDataTable {
            height: 750px;
        }

        .center {
            text-align: center !important;
        }

        input[type='checkbox'] {
            width: 20px;
            height: 20px;
        }

        button {
            margin-left: 10px;
            margin-right: 10px;
        }

        #toggle {
            margin-left: 25px;
        }

        .avirProcess,
        .qtProcess,
        .importProcess,
        .parseProcess,
        .statusProcess {
            display: none;
        }

        table {
            font-size: x-small;
        }

        #btnImport,
        #btnClose {
            display: none;
        }

        #preworkContainer{
            width:100%
        }
        #step1Help{
            margin:auto;
            display:block;
        }
        #importProgress {
            font-size: 20px;
        }

        .progress {
            height: 40px;
        }
        #bulkinput{
            overflow-x:auto;
            white-space:pre;
        }
        .warningbox{
            font-size: 15px;
            color: firebrick;
            font-weight: bold;
            border-radius: 10px;
            border: 3px solid firebrick;
            background: white;
            padding: 20px;
            line-height: 1.6;        
            margin-top:5px;
            margin-bottom:5px;
        }
        #foundImportContainer,
        #newImportContainer
        {
            display:none;
        }
        input[type=checkbox].tiny
        {
        /* Double-sized Checkboxes */
        -ms-transform: scale(.5); /* IE */
        -moz-transform: scale(.5); /* FF */
        -webkit-transform: scale(.5); /* Safari and Chrome */
        -o-transform: scale(.5); /* Opera */
        padding: 2px;
        }        
    </style>
</head>

<body>
    <div id="showTypeSelectContainer">
        <h2>Where are you importing from?</h2><br/>
        <div class="warningbox">WARNING: Importing data will make changes to your data sheet. Although CTRL+Z may help rollback the changes, it is highly recommend you make a backup copy before proceeding.</div><br/>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="switch_AVIR" onclick="setInputType('avir')" checked>
            <label clss="form-check-label" for="switch_AVIR">Amazon Vine Itemized Report</label>
        </div>
        <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="switch_QT" onclick="setInputType('qt')">
            <label clss="form-check-label" for="switch_QT">QwicksetTracking Sheet</label>
        </div><br/><br/>
        <button onclick="closeThis()" class="btn btn-secondary">Cancel</button>
        <button id='btnGetData' onclick="showPrework()" class="btn btn-primary right">Next</button>
    </div>
    <div id="AVIRContainer" class="avirProcess prework">
        <h2>Import Amazon Vine Itemized Report</h2>
        <div  class='userContainer'>
            <h3>Step 1 of 3: In your worksheet on the Ledger/Data tab...</br>
                <i style="font-size:smaller">
                    1. Download an itemized annual report from your <a href="https://www.amazon.com/vine/account" target="_blank">Vine Account</a> page<br/>
                    2. Open it in either MS Excel or Google Sheets<br/>
                    3. Highlight header and row data<br/>
                    4. Copy to clipboard
                </i><br/>
                <img id="step1Help" width="75%" src="https://drive.google.com/uc?export=view&id=1jK2uqtTGb2H8OaEb3eFt3D9mKaoE7vaJ">
            <h3 />
            <button onclick="closeThis()" class="btn btn-secondary">Cancel</button>
            <button id='btnGetData' onclick="getData()" class="btn btn-primary right">Next</button>
        </div>
    </div>    
    <div id="QTContainer" class="qtProcess prework">
        <h2>Import QwicksetTracking Data<h2/>
        <div class='userContainer'>
            <h3>Step 1 of 3 : In your worksheet on the Ledger/Data tab...</br>
                <i style="font-size:smaller">
                    1. Type <b>|***|</b> in the column to the right of <b>Notes</b><br/>
                    2. Paste <b>|***|</b> into the cells in that column for every row below that that has data<br/>
                </i><br/>
                <img id="step1Help" src="https://drive.google.com/uc?export=view&id=1fv6Jf72Sv-ULvSCWs5jQDosI7glq_ra3">
            <h3 />
            <button onclick="closeThis()" class="btn btn-secondary">Cancel</button>
            <button id='btnGetData' onclick="getData()" class="btn btn-primary right">Next</button>
        </div>
    </div>
    <div id='importContainer' class='importProcess userContainer'>
        <h3>Step 2 of 3: Cut/Paste XLSX contents here
            <h3 />
            <textarea id="bulkinput" rows="30"></textarea><br/>
            <button onclick="closeThis()" class="btn btn-secondary">Close</button>
            <button id='btnParse' onclick="parseData()" class="btn btn-primary right">Next</button>
    </div>
    <div id='parsedContainer' class='parseProcess userContainer'>
        <h3>Step 3 of 3: Select items to import</h3>
        <div id='newImportContainer'>
            <h2 id="newImportHeading">New Import Items<h2 />
            <button id="toggle" onclick="toggleChecks('#newDataTable')" class="btn btn-secondary">Toggle Selected</button>
            <div id='newDataTable'>
            </div>
        </div>
        <div id='foundImportContainer'>
            <h2 id="foundImportHeading">Existing Import Items<br></h2><i style="font-size:medium">These items have been found in your existing data. Selected items will be overwritten with selected columns.</i><br/>
            <button id="toggle" onclick="toggleChecks('#foundDataTable')" class="btn btn-secondary">Toggle Selected</button>
            <div id='foundDataTable'>
            </div>
        </div>
        <button onclick="closeThis()" class="btn btn-secondary">Cancel</button>
        <button id="btnImport" class="btn btn-primary right parseProcess disabled" onclick="confirmFoundColumns()">Import Selected</button>
    </div>
    <div id='statusContainer' class='statusProcess userContainer'>
        <h3>Import selected items...</h3>
        <div id='statusDataTable'>
        </div>
        <div class="progress">
            <div id="importProgress" class="bar" style="width: 0%;">0%</div>
        </div>
    </div>
    <div class="right">
        <button id="btnClose" onclick="closeThis()" class="btn btn-primary">Close</button>
    </div>
</body>
<script>
    class SheetItem{
        ordernumber;
        ordered;
        shipped;
        received;
        cancelled;
        asin;
        itemname;
        category;
        etv;
        msrp;
        submitteddate;
        accepteddate;
        rejecteddate;
        canceleddate;
        stars;
        photos;
        video;
        title;
        detail;
        notes;

        constructor(){}

        map(inputobject){

        }
    }

    class Utils{
        constructor(){}
        
        static logEnabled=true;

        static TableToObjectArray(dataString,endLineDelimiter='\n'){
            console.clear();
            Utils.log(`TableToObjectArray([${dataString.length} chars], '${endLineDelimiter}')`);
            var dataLines = dataString.split(endLineDelimiter).map((line) => line.split('\t'));
            var headerLine;
            var importItems=[];
            var error;
            
            Utils.log(`Processing ${dataLines.length} dataLines`);
            dataLines.every(function(line){
                var found=false;
                var index=-1;
                var importItem={};
                if (!headerLine || line.length>=headerLine.length){
                    line.every(function(element){
                        if(!headerLine){
                            //find the first with "ASIN" -- assumption this is the header
                            if (Utils.StringContains('asin',element)){
                                Utils.log(`     found header line`);
                                found=true;
                                return false; //bail out of this every instance to record header
                            }
                            return true;    //keep looking
                        } else {
                            index++;
                            var prop=headerLine[index];
                            if(prop&&prop.sheetElement) //only add if sheetElement was found
                                importItem[prop.sheetElement]={
                                    value:element,
                                    importElement:prop.element,
                                };
                            return true;
                        }
                    });
                } else {
                    Utils.log(`line skipped due to it having ${line.length} compared to headerLine having ${headerLine.length}`);
                }
                if(!headerLine){
                    if(found){
                        var cleanLine=[]
                        line.forEach(function(element){
                            if(element){
                                var cleanElement=Utils.CleanString(element).toUpperCase();
                                var sheetElement=Utils.LookupSheetElement(cleanElement);
                                cleanLine.push({
                                    element:cleanElement,
                                    sheetElement:sheetElement,
                                });
                            }
                        });
                        headerLine=cleanLine; //assign current top line to headerLine and pop it from dataLines
                    } 
                } else {
                    if (!Utils.IsEmptyObject(importItem)) importItems.push(importItem);
                }
                return true;
            });         
            headerLine=[{element:'SELECT',sheetElement:'*'},{element:'IMAGE',sheetElement:'*'}].concat(headerLine);
            importItems.forEach(function(item){
                item.SELECT={
                    value:false
                };
                item.IMAGE={
                    value:''
                };
            });
            if (headerLine){
                Utils.log(` headerLine=${JSON.stringify(headerLine).replaceAll(',',',\n')}`);
            }
            if (importItems.length){
                var i=0;
                importItems.forEach(function(item){
                    i++;
                    Utils.log(`importItem #${i}:${JSON.stringify(item).replaceAll('},','},\n     ')}`);
                });
            }
            return {
                headings:headerLine,
                items:importItems
            };
        }
        static LookupSheetElement(element){
            switch (element) {
                case 'ORDERNUMBER':
                case 'ORDERED':
                case 'SHIPPED':
                case 'RECEIVED':
                case 'CANCELED':
                case 'ASIN':
                case 'ITEMNAME':
                case 'CATEGORY':
                case 'ETV':
                case 'MSRP':
                case 'SUBMITTEDDATE':
                case 'ACCEPTEDDATE':
                case 'REJECTEDDATE':
                case 'CANCELEDDATE':
                case 'STARS':
                case 'PHOTOS':
                case 'VIDEO':
                case 'TITLE':
                case 'DETAIL':
                case 'NOTES':
                    return element;

                case 'VIDEO': return 'VIDEOS'
                case 'CANCELLED': return 'CANCELED'
                case 'CANCELLEDDATE': return 'CANCELEDDATE'
                case 'PRODUCTNAME': return 'ITEMNAME'
                case 'ORDERDATE': return 'ORDERED'
                case 'SHIPPEDDATE': return 'SHIPPED'
                case 'ESTIMATEDTAXVALUE': return 'ETV'

                default:
                    return;
            }
        }
        static CleanString(str){
            return str.replaceAll(/"/g,'').replaceAll('.','').replaceAll(' ','').replaceAll('/','').replaceAll('\n','');
        }
        static IsEmptyObject(obj){
            return JSON.stringify(obj)==='{}';
        }
        static StringsMatch(str1,str2){
            return (str1.toUpperCase()===str2.toUpperCase());
        }
        static StringContains(findThis,inThis){
            var found=false;
            
            if (findThis && inThis){
                found=(inThis.toUpperCase().indexOf(findThis.toUpperCase())>=0);
            }
            return found;             
        }
        static log(message){
            if(!Utils.logEnabled) return;
            console.log(message);
        }
    }
</script>
<script>
    $(document).ready(function () {
        showTypeSelect();
    });
    function isImportType(typeToCheck){
        return this.inputType.toUpperCase()===typeToCheck.toUpperCase();
    }
    function setInputType(type){
        inputType=type;
        console.log(`Setting inputType to ${inputType}`);
        if (type==='avir'){
            $('#switch_QT').prop("checked",false);

        } else {
            $('#switch_AVIR').prop("checked",false);
        }
    }
    function showTypeSelect(){
        console.log(`showTypeSelect()`);
        $('.typeSelect').show();
    }
    function showPrework(){
        console.log(`showPrework()`);
        $('#showTypeSelectContainer').hide();
        if (this.isImportType('qt'))
            $('.qtProcess').show();
        else 
            $('.avirProcess').show();
    }
    function showImport(ASINS) {
        sheetASINS = ASINS;
        //console.log(`showImport(${ASINS}`);
        $('.prework').hide();
        if (this.isImportType('qt'))
            $('#bulkinput').attr("placeholder",qtBulkInputPlaceholder);
        else
            $('#bulkinput').attr("placeholder",avirBulkInputPlaceholder);

        $('.importProcess').show();
    }
    function getData(){
        $('.preworkProcess').hide();
        google.script.run.withSuccessHandler(showImport).getAllASINS();
    }
    let USDollar = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
    });
    function toggleChecks(selector) {
        var totalChecks = $(`${selector} tr td input.asinCheckbox`).length;
        var totalChecked = $(`${selector} tr td input.asinCheckbox:checked`).length;
        if (!totalChecked) totalChecked = 0;
        var makeChecked = ((totalChecked / totalChecks) < 0.5);
        $(`${selector} tr td input.asinCheckbox`).prop("checked", makeChecked);
    }
    function selectAll() {
        $("#productsTable input[type=checkbox]").prop('checked', $(this).prop('checked'));
    }
    function populateImage(imgData) {
        $(`#img_${imgData.ASIN}`).attr('src', imgData.src);
        data.filter(function (item) {
            return item.ASIN == imgData.ASIN;
        }).map(function (item) {
            item.Image = imgData.src;
        });
    }
    function parseData(){
        $('.importProcess').hide();
        $('.parseProcess').show();
        var endLineDelimiter=isImportType('qt')?'|***|\n':'\n';
        var parsedData=Utils.TableToObjectArray($('#bulkinput').val(),endLineDelimiter);
        data=parsedData.items;
        headings=parsedData.headings;
        console.clear();
        Utils.log(`data=${JSON.stringify(data,null,2)}`);
        splitItems();
    }
    function orig_parseData() {
        $('.importProcess').hide();
        $('.parseProcess').show();
        var l = -1;
        var fileLines = $('#bulkinput').val().split('\n').map((line) => line.split('\t'));
        fileLines.forEach(function (fileLine) {
            l++;
            if (!headings && fileLine[0].trim() == "Order Number") {
                headings = ["Select", "Image"].concat(fileLine);
                var headingIndex = -1;
                headings.forEach(function (heading) {
                    headingIndex++;
                    if (heading.toLowerCase() == "asin") ASINIndex = headingIndex - 2;
                });
                console.log(`    headings=${JSON.stringify(headings).replaceAll(',',',\n')}`);
            } else if (headings) {
                var element = -1;
                var item = {};
                var ASIN;
                if (ASINIndex && fileLine[ASINIndex]) {
                    ASIN = fileLine[ASINIndex];
                    headings.forEach(function (heading) {
                        if (heading.toLowerCase() == "select")
                            item[heading] = false;
                        else if (heading.toLowerCase() == "image")
                            item[heading] = ""
                        else {
                            element++;
                            item[heading] = fileLine[element];
                        }
                    });
                    data.push(item);
                }
            }
        });
        splitItems();
    }
    function splitItems() {   // Between existing and new
        var newItems = [];
        var foundItems = [];
        data.forEach(function (item) {
            Utils.log(`splitItems() checking\n${JSON.stringify(item,null,2)}`);
            var found = sheetASINS.filter(function (asin) {
                return asin && asin.ASIN && asin.ASIN.toLowerCase() === item.ASIN.value.toLowerCase();
            });
            if (found.length > 0) {
                item.row=found[0].row;  //add sheet row ASIN was found at since it exists
                foundItems.push(item);
            }
            else
                newItems.push(item);
        });
        var showCount=0;
        if (newItems&&newItems.length>0){
            renderData(newItems, "#newDataTable");
            $('#newImportHeading').text(`New  Import Items (${newItems.length} items)`);
            $('#newImportContainer').show();
            showCount++;
        }

        if (foundItems&&foundItems.length>0){
            renderData(foundItems, "#foundDataTable");
            $('#foundImportHeading').text(`Found Import Items (${foundItems.length} items)`);
            $('#foundImportContainer').show();
            showCount++;
        }
        if (showCount==1){
            $('#newDataTable').height($('#newDataTable').height()*2.5);
            $('#foundDataTable').height($('#foundDataTable').height()*2.5);
        }
        
    }

    function orig_splitItems() {   // Between existing and new
        var newItems = [];
        var foundItems = [];
        data.forEach(function (item) {
            var found = sheetASINS.filter(function (asin) {
                return asin && asin.toLowerCase() === item.ASIN.toLowerCase();
            });
            if (found.length > 0) {
                foundItems.push(item);
            }
            else
                newItems.push(item);
        });
        var showCount=0;
        if (newItems&&newItems.length>0){
            renderData(newItems, "#newDataTable");
            $('#newImportHeading').text(`New  Import Items (${newItems.length} items)`);
            $('#newImportContainer').show();
            showCount++;
        }

        if (foundItems&&foundItems.length>0){
            renderData(foundItems, "#foundDataTable");
            $('#foundImportHeading').text(`Found Import Items (${foundItems.length} items)`);
            $('#foundImportContainer').show();
            showCount++;
        }
        if (showCount==1){
            $('#newDataTable').height($('#newDataTable').height()*2.5);
            $('#foundDataTable').height($('#foundDataTable').height()*2.5);
        }
        
    }

    function getTableHeading(checkboxes,justTheASINS) {
        var tableHtml = '<table class="table table-stiped"><thead>';
        headings.forEach(function (heading) {
            var extra = '';
            if (checkboxes &&
                heading.element.toUpperCase()!=='IMAGE' &&
                heading.element.toUpperCase()!=='SELECT') {
                extra=`<br/><input class='tiny' type="checkbox" id='colchk_${heading.element}'/>`;
            }
            if (heading.sheetElement && (!justTheASINS || heading.sheetElement.toUpperCase()==='ASIN'))
                tableHtml = `${tableHtml}<th scope='col'>${heading.sheetElement==='*'?heading.element:heading.sheetElement}${extra}</th>`;
        });
        tableHtml = `${tableHtml}</tr></thead><tbody>`;
        return tableHtml;
    }
    function orig_getTableHeading(checkboxes,justTheASINS) {
        var tableHtml = '<table class="table table-stiped"><thead>';
        headings.forEach(function (heading) {
            var extra = '';
            if (checkboxes &&
                heading.toUpperCase()!=='IMAGE' &&
                heading.toUpperCase()!=='SELECT') {
                extra=`<br/><input class='tiny' type="checkbox" id='colchk_${heading}'/>`;
            }
            if (!justTheASINS || heading.toUpperCase()==='ASIN')
                tableHtml = `${tableHtml}<th scope='col'>${heading}${extra}</th>`;
        });
        tableHtml = `${tableHtml}</tr></thead><tbody>`;
        return tableHtml;
    }
    function checked() {
        if ($('div#newDataTable input:checkbox:checked')) {
            ('#btnImport').removeClass('disabled');
        } else {
            ('#btnImport').addClass('disabled');
        }
    }
    function getTableItem(item,justTheASINS) {
        console.clear();
        Utils.log(`getTableItem(\n${JSON.stringify(item,null,2)},${justTheASINS})`);
        Utils.log(`     headings(\n${JSON.stringify(headings,null,2)}`);
        var foundImgWidth = 25;
        var tableHtml = `<tr>`;
        headings.forEach(function (heading) {
            Utils.log(`heading=${JSON.stringify(heading,null,2)}`);
            element=heading.element;
            sheetHeading=heading.sheetElement;
            if (sheetHeading){
                if (element == "SELECT" || element == "SAVED") {
                    var extra = "";
                    if (element == "SAVED") extra = "readonly";
                    tableHtml = `${tableHtml}<td class="center"><input onclick="checked" class='asinCheckbox' type='checkbox' id='chk_${item.ASIN.value}' ${extra}></td>`;
                } else if (element == "IMAGE") {
                    if (!item.Image || item.Image.length == 0) item.Image = getProductImageURL(item.ASIN.value);
                    tableHtml = `${tableHtml}<td><img style='width:${foundImgWidth}px' id='img_${item.ASIN.value}' src="${item.Image}"/></td>`;
                } else {
                    var value = item[heading.sheetElement].value;
                    if (heading.sheetElement == "ITEMNAME" ||
                        heading.sheetElement == "NOTES" ||
                        heading.sheetElement == "TITLE" ||
                        heading.sheetElement == "DETAI") {
                        if (value.length > 50) value = `${value.substring(0, 50)}...`;
                    }
                    if (!justTheASINS || heading.sheetElement==='ASIN')
                        tableHtml = `${tableHtml}<td>${value}</td>`;
                }
            }
        });
        tableHtml = `${tableHtml}</tr>`;
        return tableHtml;
    }
    function orig_getTableItem(item,justTheASINS) {
        var foundImgWidth = 25;
        var tableHtml = `<tr>`;
        headings.forEach(function (heading) {
            if (heading.toLowerCase() == "select" || heading.toLowerCase() == "saved") {
                var extra = "";
                if (heading.toLowerCase() == "saved") extra = "readonly";
                tableHtml = `${tableHtml}<td class="center"><input onclick="checked" class='asinCheckbox' type='checkbox' id='chk_${item.ASIN.value}' ${extra}></td>`;
            } else if (heading.toLowerCase() == "image") {
                if (!item.Image || item.Image.length == 0) item.Image = getProductImageURL(item.ASIN.value);
                tableHtml = `${tableHtml}<td><img style='width:${foundImgWidth}px' id='img_${item.ASIN.value}' src="${item.Image}"/></td>`;
            } else {
                var value = item[heading].value;
                if (heading.toLowerCase() == "product name" ||
                    heading.toLowerCase() == "notes" ||
                    heading.toLowerCase() == "title" ||
                    heading.toLowerCase() == "detail") {
                    if (value.length > 50) value = `${value.substring(0, 50)}...`;
                }
                if (!justTheASINS || heading.toUpperCase()==='ASIN')
                    tableHtml = `${tableHtml}<td>${value}</td>`;
            }
        });
        tableHtml = `${tableHtml}</tr>`;
        return tableHtml;
    }
    function getProductImageURL(asin) {
        return "https://ws-na.amazon-adsystem.com/widgets/q?_encoding=UTF8&MarketPlace=US&ASIN=" + asin + "&ServiceVersion=20070822&ID=AsinImage&WS=1&Format=_SL150_";
    }

    function getTableFooter() {
        return `</tbody></table>`;
    }

    function renderData(splitData, selector) {
        var headingCheckboxes=(selector.toUpperCase()==='#FOUNDDATATABLE');
        var justTheASINS=(selector.toUpperCase()==='#STATUSDATATABLE');
        var tableHtml = `${getTableHeading(headingCheckboxes,justTheASINS)}`;
        //var imgASINS=[];
        splitData.forEach(function (item) {
            tableHtml = `${tableHtml}${getTableItem(item,justTheASINS)}`;
            //imgASINS.push(item.ASIN.value);
        });
        tableHtml = `${tableHtml}${getTableFooter()}`;
        $(selector).append(tableHtml);
    }
    function getSelectedFoundColumns(){
        return $('div#foundDataTable input[id^="colchk_"]:checkbox:checked').map(function(){return this.id;}).get();
    }
    function getSelectedFoundColumnsClean(){
        var selectedFoundColumns=getSelectedFoundColumns();
        var columns= selectedFoundColumns.map(function(column){ return column.replaceAll('colchk_','');})
        console.log(`getSelectedFoundColumnsClean()=${columns}`);
        return columns;
    }
    function confirmFoundColumns(){
        var foundsSelectedCount=$('div#foundDataTable input[id^="chk_"]:checkbox:checked').length;
        var colsSelected=getSelectedFoundColumns();
        var colsSelectedCount=colsSelected.length;
        console.log(`confrirmFoundColumns()\n     foundsSelected=${foundsSelectedCount}\n     colsSelected=${colsSelectedCount}`);
        if (foundsSelectedCount>0){
            if (colsSelectedCount==0){
                google.script.run.alert('No found columns selected to update',`${foundsSelectedCount} items selected to update but 0 columns selected to overwrite.\n\nPlease select at least one column's data to overwrite for the selected items.`, 'OK');    
            } else {
                google.script.run.withSuccessHandler(foundContinueHandler).alert('Confirm found items update',`${foundsSelectedCount} existing sheet items will have the following columns updated:\n\n${getSelectedFoundColumnsClean().join('\n')}\n\nContinue?.`, 'YES_NO');    
            }
        }
    }
    function foundContinueHandler(confirm){
        if (confirm && (confirm==='OK' || confirm==='YES')){
            getLastRow();
        } else {
            console.log('Canceled');
        }
    }
    function getLastRow() {
        google.script.run.withSuccessHandler(importItems).nextNewRow();
    }
    function importItems(firstRow) {
        console.log(`importItems(${firstRow})`);
        $('.parseProcess').hide();
        $('.statusProcess').show();
        var ASINS = [];
        $('div#newDataTable input[id^="chk_"]:checkbox:checked').each(function (index) {
            ASINS.push($(this).attr("id").replace('chk_', ''));
        });
        if (ASINS&&ASINS.length>0){
            updateASINS(ASINS,firstRow);
            ASINS=[];
        } 
        $('div#foundDataTable input[id^="chk_"]:checkbox:checked').each(function (index) {
            ASINS.push($(this).attr("id").replace('chk_', ''));
        });
        if (ASINS&&ASINS.length>0){
            updateASINS(ASINS,firstRow,getSelectedFoundColumnsClean());
        }
    }
    function updateASINS(ASINS,firstRow,selectedColumns=undefined){
        console.log(`updateASINS() ${ASINS.length} ASINS passed in. ${!selectedColumns?0:selectedColumns.length} selected Columns passed in.`);
        if (!ASINS||ASINS.length===0) return;

        var dataSelected = data.filter(function (item) {
            return ASINS.indexOf(item.ASIN) >= 0;
        })
        var dataToSave = [];
        dataSelected.forEach(function (data) {
            var newData = {};
            headings.forEach(function (heading) {
                if (heading.toUpperCase() === "SELECT"){
                    newData.Saved = false;
                } else {
                    if (!selectedColumns || selectedColumns.length===0 || selectedColumns.filter(function(column){return column.toUpperCase()===heading.toUpperCase();}).length!==0){
                        newData[heading] = data[heading];
                        console.log(`     newData[${heading}] assigned.`);
                    } else {
                        console.log(`     did not find '${heading.toUpperCase()}' within ${JSON.stringify(selectedColumns)}`);
                    }
                }
            });
            dataToSave.push(newData);
        });
        headings[0] = 'Saved';
        renderData(dataToSave, "#statusDataTable");

        console.log('\n\n\n\n****************************');
        //var row = firstRow - 1;
        //dataToSave.forEach(function (item) {
            //row++;
            //console.log(`google.script.run.withSuccessHandler(markAsSaved).addItemToSheet(${item.ASIN}) at row ${row}`);
            addItemToSheet({
                items:dataToSave,
                row:firstRow,
                index:0,
                batchSize:20
            });
        //});
        console.log(`refresh data...`);
        google.script.run.flushAll();
        console.log(`refreshed`);
        console.log('****************************\n\n\n\n');
    }
    function addItemToSheet(results){
        console.log('\n\n\n****************************');
        console.log(`addItemToSheet()\n`);
        console.log(`     items (ASINS): ${results.items.filter(function(item){return item.ASIN;})}\n`);
        console.log(`     batchSize:${results.batchSize}\n`);
        console.log(`     index:${results.index}\n`);
        console.log(`     row:${results.row}\n`);
        console.log(`     savedASINSStartIndex:${results.savedASINSStartIndex}\n`);
        console.log(`     savedASINSEndIndex:${results.savedASINSEndIndex}\n`);

        if (results.savedASINSStartIndex||results.savedASINSStartIndex===0){
            for(var i=results.savedASINSStartIndex;i<=results.savedASINSEndIndex;i++){
                console.log(`markAsSaved for index #${i}`);
                console.log(`     ASIN=${results.items[i].ASIN})`);
                markAsSaved(results.items[i].ASIN);
            }
        } 
        if (results.index<results.items.length-1) {
            console.log(`calling addItemToSheet on server`);
            google.script.run.withSuccessHandler(addItemToSheet).addItemToSheet(results);
        } else {
            console.log(`done with addItemToSheet() batching.`);
        }
    }
    function markAsSaved(asin) {
        var total = $('div#statusDataTable input:checkbox').length;
        var notChecked = $('div#statusDataTable input:checkbox:not(:checked)').length;
        var checked = $('div#statusDataTable input:checkbox:checked').length;
        var progress = Math.round(checked * 100 / total);

        setProgress(progress);
        console.log(`ASIN ${asin} saved.`);
        console.log(`     checked=${$(`div#statusDataTable input#chk_${asin}`).is(":checked")}`);
        $(`div#statusDataTable #chk_${asin}`).prop('checked', true);
        console.log(`     checked=${$(`div#statusDataTable input#chk_${asin}`).is(":checked")}`);
        if ($('div#statusDataTable input:checkbox:not(:checked)').length == 0)  //check if none aren't checked, we're done
        {
            $('#btnImport').hide();
            $('#btnClose').show();
            setProgress(100);
        }
    }
    function setProgress(n) {
        console.log(`setProgress(${n})`);
        $('#importProgress').css('width', `${n}%`).text(`${n}%`);
    }
    function closeThis() {
        google.script.host.close();
    }

    var data = [];
    var headings;
    var sheetASINS = [];
    var inputType='AVIR';
    var qtBulkInputPlaceholder=`Example:\n\nStatus\tOrdered\tShipped\tReceived\tMoldy/ Overdue\tASIN\tItem Name\tCategory\tETV\tMSRP\tLow Est. Tax\tHigh Est. Tax\tProd URL\tRev URL\t"Submitted\n`;
    qtBulkInputPlaceholder=`${qtBulkInputPlaceholder}Date"\t"Accepted\n`;
    qtBulkInputPlaceholder=`${qtBulkInputPlaceholder}Date"\t"Rejected\n`;
    qtBulkInputPlaceholder=`${qtBulkInputPlaceholder}Date"\t"Cancelled\n`;
    qtBulkInputPlaceholder=`${qtBulkInputPlaceholder}Date"\t"Submitted\n`;
    qtBulkInputPlaceholder=`${qtBulkInputPlaceholder}Age"\t"Accepted\n`;
    qtBulkInputPlaceholder=`${qtBulkInputPlaceholder}Age"\tStars\tPhotos\tVideo\t"Character \n`;
    qtBulkInputPlaceholder=`${qtBulkInputPlaceholder}Length"\tTitle\tDetail\tNotes\t|***|\n`;
    qtBulkInputPlaceholder=`${qtBulkInputPlaceholder}5 Rejected\t10/1/2023\t\t\t\tB0CFPHHX9B\tUltrawall BIKEPAL Swivel Bike Racks, Wall Mounted Bike Storage Solution for Home, Garage Bike Hanger, 2 Pack\tCycling\t$110.49\t$110.49\t$26.52\t$35.36\tProduct\tReview\t1/1/2001\t2/2/2002\t3/3/2003\t4/4/2004\t\t397\t3\t2\t1\t11\tTitle TEST\tDetail TEST\tNotes TEST\t|***|\n`;
    qtBulkInputPlaceholder=`${qtBulkInputPlaceholder}0 Ordered\t10/1/2023\t\t\t\tB0CFPHNYPQ\tTORACK BIKEPAL No Lifting Swivel Bike Racks, Space Saving Wall Mounted Bike Holder for Garage, Vertical Bike Wall Hangers for Home Bike Storage Solution (2 Pack)\tCycling\t$115.99\t$115.99\t$27.84\t$37.12\tProduct\tReview\t\t\t\t\t\t\t\t\t\t\t\t\t \t|***|\n`;
    qtBulkInputPlaceholder=`${qtBulkInputPlaceholder}     . . .\n     . . .\n     . . .\n`;    
    qtBulkInputPlaceholder=`${qtBulkInputPlaceholder}2 Received\t8/28/2023\t8/29/2023\t8/30/2023\t93d overdue\tB097C7VK88\tNatgrown PQQ Supplement 20 mg - Pyrroloquinoline Quinone - Promotes Mitochondrial Biogenesis - Supports Heart & Brain Health - 60 Capsules\tHealth\t$0.00\t$29.97\t$0.00\t$0.00\tProduct\tReview\t\t\t\t\t\t\t\t\t\t19\tAnother Title TEST\tAnother Detail TEST\tAnother Notes TEST\t|***|\n`;

    var avirBulkInputPlaceholder=`Example:\n\r\nAmazon Vine Itemized Report for 2023							\n\n`;
    avirBulkInputPlaceholder=`${avirBulkInputPlaceholder}Order Number	ASIN	Product Name	Order Type	Order Date	Shipped Date	Cancelled Date	Estimated Tax Value\n`;
    avirBulkInputPlaceholder=`${avirBulkInputPlaceholder}113-2043995-9999999	B0BBSNABCD	Foo Bar	ORDER	01/31/2023	01/31/2023		0\n`;
    avirBulkInputPlaceholder=`${avirBulkInputPlaceholder}113-5790246-9999999	B0BS3MABCD	Widget v2.0	ORDER	02/06/2023	02/07/2023		0\n`;
    avirBulkInputPlaceholder=`${avirBulkInputPlaceholder}113-0432681-9999999	B0BRQ2ABCD	Whammo!	ORDER	02/09/2023	02/10/2023		0\n`;
    avirBulkInputPlaceholder=`${avirBulkInputPlaceholder}     . . .\n     . . .\n     . . .\n`;    
    avirBulkInputPlaceholder=`${avirBulkInputPlaceholder}113-3610706-9999999	B0BQDABCD	K-Tel Record	ORDER	02/14/2023	02/15/2023		0\n`;

</script>

</html>